#!/usr/bin/env bash

cd ~

year="$(date -d 'now' '+%Y')"
name="$(date -d 'now' '+%Y-%m-%d')"

curl ${STREAM_URL} --max-time ${DURATION} --output "${name}.mp3"

mp3val "${name}.mp3" \
    -f \
    -nb         # Fix errors & remove backup files created during file rebuilding

ffmpeg -i "${name}.mp3" -filter:a "volume=-20dB" "${name}.gain.mp3"
rm "${name}.mp3"
mv "${name}.gain.mp3" "${name}.mp3"

curl ${MP3_ICON} --output mp3-icon

eyeD3 --release-year="${year}" \
    --recording-date="${name}" \
    --title="${name}" \
    --album="${SHOW_TITLE}" \
    --artist="${STATION_NAME}" \
    --genre="${GENRE}" \
    --add-image=icon:mp3-icon "${name}.mp3"

echo "OAUTH_ACCESS_TOKEN=${DROPBOX_TOKEN}" > .dropbox_uploader

bash ./dropbox_uploader.sh -f .dropbox_uploader upload "${name}.mp3" "${name}.mp3"
